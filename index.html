<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Localization Web App</title>

<style>
  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
  }

  body {
    font-family: system-ui, Arial, sans-serif;
    min-height: 100vh;
    padding: 0;
    background: linear-gradient(135deg,#7e5095 0%,#372483 50%,#201e40 100%);
    color: white;
  }

  h1 { font-size: 26px; margin: 0 0 8px; }
  .muted { color: rgba(255,255,255,0.75); font-size: 13px; margin: 0 0 16px; }

  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .login-card {
    max-width: 380px;
    width: 100%;
    background: rgba(0,0,0,0.45);
    border-radius: 16px;
    padding: 24px 20px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
  }

  .login-card h1 { font-size: 22px; margin-bottom: 6px; }
  .login-card p { margin: 0 0 18px; }

  .login-card input[type="text"],
  .login-card input[type="password"] {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.5);
    background: rgba(0,0,0,0.25);
    color: white;
    font-size: 14px;
    margin-bottom: 10px;
  }

  .login-card input::placeholder { color: rgba(255,255,255,0.7); }

  .btn {
    padding: 10px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.5);
    background: rgba(0,0,0,0.35);
    color: white;
    cursor: pointer;
    font-size: 14px;
  }

  .btn-primary { font-weight: 700; text-transform: uppercase; }
  .btn-right { margin-left: auto; }
  .btn-small { padding: 6px 12px; font-size: 12px; }
  .btn:hover:not(:disabled) { background: rgba(255,255,255,0.15); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin: 16px 0;
  }

  #appShell { display: none; padding: 32px 40px 40px; }

  #topBar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
  }

  #topBarTitle { font-size: 20px; font-weight: 600; }

  /* Bigger “Hi, Marcus” */
  #authStatus {
    margin-left: auto;
    font-weight: 700;
    font-size: 18px;
    color: #fff;
  }

  .tabs {
    display: inline-flex;
    background: rgba(0,0,0,0.25);
    border-radius: 999px;
    padding: 4px;
    margin-bottom: 20px;
  }

  .tab-btn {
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.8);
    padding: 8px 18px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 14px;
  }

  .tab-btn.tab-active {
    background: rgba(255,255,255,0.18);
    color: white;
  }

  textarea {
    width: 100%;
    min-height: 160px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 12px;
    background: rgba(0, 0, 0, 0.25);
    color: white;
    font-size: 15px;
  }

  textarea::placeholder { color: rgba(255,255,255,0.6); }

  input[type="text"], select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.5);
    background: rgba(0,0,0,0.25);
    color: white;
    font-size: 14px;
  }

  input::placeholder { color: rgba(255,255,255,0.7); }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(0,0,0,0.25);
    border-radius: 12px;
    overflow: hidden;
    margin-top: 20px;
  }

  th, td {
    border: 1px solid rgba(255,255,255,0.15);
    padding: 12px;
    font-size: 14px;
    vertical-align: top;
  }

  th { background: rgba(0,0,0,0.35); font-weight: bold; }

  #translateSection, #projectsSection, #adminSection { margin-top: 12px; }

  #blockBar {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .block-active { background: rgba(255,255,255,0.3); }

  /* small badge for admin */
  .badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 12px;
    background: rgba(255,255,255,0.18);
    border: 1px solid rgba(255,255,255,0.25);
    margin-left: 8px;
  }
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-card">
    <h1>AI Localization Tool</h1>
    <p class="muted">Sign in with your email to access projects and translations.</p>

    <input type="text" id="authEmail" placeholder="Email">
    <input type="password" id="authPassword" placeholder="Password">

    <div class="row" style="margin-top: 8px;">
      <button class="btn btn-primary" id="loginBtn">Sign in</button>
      <button class="btn" id="signupBtn">Sign up</button>
    </div>

    <p class="muted" id="loginHint" style="margin-top: 10px;">
      New user? Use Sign up. Returning user? Sign in with your existing account.
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="appShell">
  <div id="topBar">
    <div id="topBarTitle">AI Localization Web App</div>
    <span id="authStatus" class="muted">Not logged in</span>
    <button class="btn" id="logoutBtn">Log out</button>
  </div>

  <p class="muted">Translate marketing copy, save projects, and manage previous work.</p>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn tab-active" id="tabTranslate">Translate</button>
    <button class="tab-btn" id="tabProjects">Projects</button>
    <button class="tab-btn" id="tabAdmin" style="display:none;">Admin</button>
  </div>

  <!-- TRANSLATE TAB -->
  <div id="translateSection">
    <div class="row">
      <label>
        Project name:
        <input type="text" id="projectName" placeholder="E.g. Bosch October captions">
      </label>

      <label>
        Status:
        <select id="projectStatus">
          <option value="Draft">Draft</option>
          <option value="Reviewed">Reviewed</option>
          <option value="Approved">Approved</option>
        </select>
      </label>

      <label>
        Reviewed by:
        <input type="text" id="reviewedBy" placeholder="Reviewer name">
      </label>
    </div>

    <p id="reviewedInfo" class="muted"></p>

    <div class="row" id="blockBar"></div>

    <label>English text</label>
    <textarea id="en" placeholder="Paste English text here..."></textarea>

    <div class="row" id="langs">
      <label><input type="checkbox" value="zh-TW" checked> zh-TW (Traditional Chinese)</label>
      <label><input type="checkbox" value="zh-CN" checked> zh-CN</label>
      <label><input type="checkbox" value="ja-JP" checked> ja-JP</label>
      <label><input type="checkbox" value="th-TH" checked> th-TH</label>
      <label><input type="checkbox" value="vi-VN" checked> vi-VN</label>
    </div>

    <div class="row">
      <button class="btn btn-primary" id="translateBtn">TRANSLATE</button>
      <button class="btn btn-primary" id="translateAllBtn">TRANSLATE ALL BLOCKS</button>

      <button class="btn" id="saveProjectBtn">Save project</button>
      <button class="btn" id="updateProjectBtn">Update project</button>

      <button class="btn btn-right" id="csvBtn">Download CSV</button>
    </div>

    <div id="status" class="muted"></div>

    <table id="out">
      <tr><th>Language</th><th>Translation (editable)</th><th>Copy</th></tr>
    </table>
  </div>

  <!-- PROJECTS TAB -->
  <div id="projectsSection" style="display:none;">
    <h2>Projects</h2>

    <div class="row">
      <input type="text" id="projectSearch" placeholder="Search project name...">
      <select id="statusFilter">
        <option value="">All statuses</option>
        <option value="Draft">Draft</option>
        <option value="Reviewed">Reviewed</option>
        <option value="Approved">Approved</option>
      </select>
      <button class="btn" id="loadProjectsBtn">Refresh</button>
    </div>

    <table id="projectsTable" style="margin-top:16px;">
      <tr>
        <th>Project Name</th>
        <th>Status</th>
        <th>Languages</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </table>
  </div>

  <!-- ADMIN TAB -->
  <div id="adminSection" style="display:none;">
    <h2>Admin <span class="badge">Full Access</span></h2>
    <p class="muted">View all users’ projects, approve status, and remove duplicates.</p>

    <div class="row">
      <input type="text" id="adminSearch" placeholder="Search project name...">
      <select id="adminStatusFilter">
        <option value="">All statuses</option>
        <option value="Draft">Draft</option>
        <option value="Reviewed">Reviewed</option>
        <option value="Approved">Approved</option>
      </select>
      <button class="btn" id="adminLoadBtn">Load all projects</button>
    </div>

    <table id="adminProjectsTable" style="margin-top:16px;">
      <tr>
        <th>Project</th>
        <th>Owner</th>
        <th>Status</th>
        <th>Languages</th>
        <th>Date</th>
        <th>Admin Actions</th>
      </tr>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =====================
   SUPABASE AUTH SETUP
===================== */
const SUPABASE_URL = "https://dtctdmsdeurllyflwjwk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0Y3RkbXNkZXVybGx5Zmx3andrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjM3NzgsImV4cCI6MjA3ODkzOTc3OH0.VgLKd9iSIzTEtHwFkaD-5x1QQE6ir8g4CasmgvTtCGI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentProjectId = null;
let isAdmin = false;

/* =====================
   MULTI-BLOCK STATE
===================== */
function makeEmptyBlock() { return { englishText: "", translations: {} }; }
let blocks = [];
let currentBlockIndex = 0;

/* =====================
   DOM SHORTCUTS
===================== */
const $ = s => document.querySelector(s);
const out = $("#out");
const statusEl = $("#status");

const loginScreen = $("#loginScreen");
const appShell = $("#appShell");

const tabTranslate = $("#tabTranslate");
const tabProjects = $("#tabProjects");
const tabAdmin = $("#tabAdmin");

const translateSection = $("#translateSection");
const projectsSection = $("#projectsSection");
const adminSection = $("#adminSection");

const authEmail = $("#authEmail");
const authPassword = $("#authPassword");
const signupBtn = $("#signupBtn");
const loginBtn = $("#loginBtn");
const logoutBtn = $("#logoutBtn");
const authStatus = $("#authStatus");

const projectSearch = $("#projectSearch");
const statusFilter = $("#statusFilter");

function setStatus(msg){ statusEl.textContent = msg || ""; }

function getSelectedLanguages() {
  return [...document.querySelectorAll('#langs input[type=checkbox]:checked')].map(x => x.value);
}

function displayLanguage(code) {
  if (code === "zh-TW") return "zh-TW (Traditional Chinese)";
  return code;
}

function getDisplayNameFromEmail(email) {
  if (!email) return "User";
  const raw = email.split("@")[0];
  const parts = raw.split(/[.\-_]/g).filter(Boolean);
  const pretty = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(" ");
  return pretty || email;
}

/* =====================
   TABS
===================== */
function showTranslateTab() {
  tabTranslate.classList.add("tab-active");
  tabProjects.classList.remove("tab-active");
  tabAdmin.classList.remove("tab-active");
  translateSection.style.display = "";
  projectsSection.style.display = "none";
  adminSection.style.display = "none";
}

function showProjectsTab() {
  tabTranslate.classList.remove("tab-active");
  tabProjects.classList.add("tab-active");
  tabAdmin.classList.remove("tab-active");
  translateSection.style.display = "none";
  projectsSection.style.display = "";
  adminSection.style.display = "none";
}

function showAdminTab() {
  tabTranslate.classList.remove("tab-active");
  tabProjects.classList.remove("tab-active");
  tabAdmin.classList.add("tab-active");
  translateSection.style.display = "none";
  projectsSection.style.display = "none";
  adminSection.style.display = "";
}

tabTranslate.onclick = showTranslateTab;

tabProjects.onclick = () => {
  showProjectsTab();
  const btn = $("#loadProjectsBtn");
  if (btn) btn.click();
};

tabAdmin.onclick = () => {
  showAdminTab();
  const btn = $("#adminLoadBtn");
  if (btn) btn.click();
};

/* =====================
   AUTH + ROLE CHECK
===================== */
async function getAccessToken() {
  const { data } = await supa.auth.getSession();
  return data?.session?.access_token || null;
}

async function refreshRoleUI() {
  isAdmin = false;
  tabAdmin.style.display = "none";

  // Non-admin: prevent selecting Approved
  const statusSel = $("#projectStatus");
  const approvedOpt = [...statusSel.options].find(o => o.value === "Approved");
  if (approvedOpt) approvedOpt.disabled = true;

  const token = await getAccessToken();
  if (!token) return;

  const r = await fetch("/api/getRole", {
    headers: { Authorization: "Bearer " + token }
  });
  const j = await r.json();
  if (!r.ok) return;

  isAdmin = (j.role === "admin");
  if (isAdmin) {
    tabAdmin.style.display = "";
    if (approvedOpt) approvedOpt.disabled = false;
  }
}

async function refreshUser() {
  const { data, error } = await supa.auth.getUser();
  if (error || !data.user) {
    currentUser = null;
    authStatus.textContent = "Not logged in";
    authStatus.title = "";
    appShell.style.display = "none";
    loginScreen.style.display = "flex";
    return;
  }

  currentUser = data.user;
  const email = currentUser.email || "";
  const displayName = getDisplayNameFromEmail(email);

  authStatus.textContent = "Hi, " + displayName;
  authStatus.title = email;

  loginScreen.style.display = "none";
  appShell.style.display = "block";

  await refreshRoleUI();
}

signupBtn.onclick = async () => {
  const email = authEmail.value.trim();
  const pw = authPassword.value.trim();
  if (!email || !pw) return alert("Enter email and password.");
  const { error } = await supa.auth.signUp({ email, password: pw });
  if (error) alert("Sign up error:\n" + error.message);
  else alert("Sign up successful. You can now sign in.");
};

loginBtn.onclick = async () => {
  const email = authEmail.value.trim();
  const pw = authPassword.value.trim();
  if (!email || !pw) return alert("Enter email and password.");
  const { error } = await supa.auth.signInWithPassword({ email, password: pw });
  if (error) alert("Login error:\n" + error.message);
  else await refreshUser();
};

logoutBtn.onclick = async () => {
  await supa.auth.signOut();
  await refreshUser();
};

/* =====================
   BLOCKS
===================== */
function clearTranslationsTable() {
  out.innerHTML = `<tr><th>Language</th><th>Translation (editable)</th><th>Copy</th></tr>`;
}

function collectTranslations() {
  const obj = {};
  [...out.querySelectorAll("tr")].slice(1).forEach(tr => {
    const t = tr.querySelectorAll("td");
    const langCode = t[0].dataset.lang || t[0].innerText;
    obj[langCode] = t[1].innerText;
  });
  return obj;
}

function syncCurrentBlockFromUI() {
  if (!blocks[currentBlockIndex]) return;
  blocks[currentBlockIndex].englishText = $("#en").value.trim();
  blocks[currentBlockIndex].translations = collectTranslations();
}

function renderCurrentBlockToUI() {
  const blk = blocks[currentBlockIndex] || makeEmptyBlock();
  $("#en").value = blk.englishText || "";
  clearTranslationsTable();
  const translations = blk.translations || {};
  const langs = Object.keys(translations);
  if (!langs.length) return;

  for (const lang of langs) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-lang="${lang}">${displayLanguage(lang)}</td>
      <td contenteditable="true">${(translations[lang] || "").replaceAll("<","&lt;")}</td>
      <td><button class="btn btn-small copy-btn">Copy</button></td>`;
    out.appendChild(tr);
  }
}

function renderBlockTabs() {
  const bar = $("#blockBar");
  if (!bar) return;
  bar.innerHTML = "";

  const label = document.createElement("span");
  label.className = "muted";
  label.textContent = "Text blocks:";
  bar.appendChild(label);

  blocks.forEach((blk, idx) => {
    const btn = document.createElement("button");
    btn.className = "btn btn-small block-tab" + (idx === currentBlockIndex ? " block-active" : "");
    btn.dataset.index = idx;
    btn.textContent = "Block " + (idx + 1);
    bar.appendChild(btn);
  });

  const addBtn = document.createElement("button");
  addBtn.className = "btn btn-small";
  addBtn.id = "addBlockBtn";
  addBtn.textContent = "+ Add block";
  bar.appendChild(addBtn);

  const delBtn = document.createElement("button");
  delBtn.className = "btn btn-small";
  delBtn.id = "deleteBlockBtn";
  delBtn.textContent = "Delete block";
  bar.appendChild(delBtn);
}

function initBlocks() {
  blocks = [makeEmptyBlock()];
  currentBlockIndex = 0;
  renderBlockTabs();
  renderCurrentBlockToUI();
}

/* =====================
   ON LOAD
===================== */
window.addEventListener("load", () => {
  refreshUser();
  initBlocks();
});

/* =====================
   TRANSLATE CURRENT
===================== */
$("#translateBtn").onclick = async () => {
  const text = $("#en").value.trim();
  if (!text) return alert("Please paste English text in the current block.");

  const targets = getSelectedLanguages();
  if (!targets.length) return alert("Select at least one language.");

  setStatus("Translating current block…");
  $("#translateBtn").disabled = true;
  $("#translateAllBtn").disabled = true;

  try {
    const r = await fetch("/api/translate", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text, targets })
    });

    const j = await r.json();
    if (!r.ok) throw new Error(j.error || "Translation failed");

    clearTranslationsTable();

    for (const [lang,val] of Object.entries(j.translations||{})) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-lang="${lang}">${displayLanguage(lang)}</td>
        <td contenteditable="true">${(val||"").replaceAll("<","&lt;")}</td>
        <td><button class="btn btn-small copy-btn">Copy</button></td>`;
      out.appendChild(tr);
    }

    syncCurrentBlockFromUI();
    setStatus("Done.");
  } catch (err) {
    alert("Translation error:\n" + err.message);
    setStatus("Error.");
  } finally {
    $("#translateBtn").disabled = false;
    $("#translateAllBtn").disabled = false;
  }
};

/* =====================
   TRANSLATE ALL BLOCKS
===================== */
$("#translateAllBtn").onclick = async () => {
  syncCurrentBlockFromUI();

  const targets = getSelectedLanguages();
  if (!targets.length) return alert("Select at least one language.");

  const hasAnyText = blocks.some(b => (b.englishText || "").trim());
  if (!hasAnyText) return alert("Please enter English text in at least one block.");

  setStatus("Translating all blocks…");
  $("#translateBtn").disabled = true;
  $("#translateAllBtn").disabled = true;

  try {
    for (let i = 0; i < blocks.length; i++) {
      const text = (blocks[i].englishText || "").trim();
      if (!text) continue;

      const r = await fetch("/api/translate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ text, targets })
      });

      const j = await r.json();
      if (!r.ok) throw new Error(j.error || `Translation failed on block ${i + 1}`);
      blocks[i].translations = j.translations || {};
    }

    renderCurrentBlockToUI();
    setStatus("All blocks translated.");
  } catch (err) {
    alert("Translate all error:\n" + err.message);
    setStatus("Error during translate all.");
  } finally {
    $("#translateBtn").disabled = false;
    $("#translateAllBtn").disabled = false;
  }
};

/* =====================
   COPY
===================== */
out.addEventListener("click", async e => {
  if (!e.target.matches(".copy-btn")) return;
  const text = e.target.closest("tr").querySelector("td:nth-child(2)").innerText;
  await navigator.clipboard.writeText(text);
  setStatus("Copied!");
});

/* =====================
   CSV EXPORT
===================== */
$("#csvBtn").onclick = () => {
  const rows = [["Language","Translation"]];
  [...out.querySelectorAll("tr")].slice(1).forEach(tr => {
    const t = tr.querySelectorAll("td");
    rows.push([t[0].innerText, t[1].innerText]);
  });
  if (rows.length === 1) return alert("No translations to export.");
  const csv = rows.map(r => r.map(s=>`"${(s||"").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "translations.csv";
  a.click();
};

/* =====================
   SAVE / UPDATE (your existing endpoints)
===================== */
$("#saveProjectBtn").onclick = async () => {
  if (!currentUser) return alert("Please sign in before saving a project.");

  syncCurrentBlockFromUI();

  const name = $("#projectName").value.trim();
  const status = $("#projectStatus").value;
  const reviewedBy = $("#reviewedBy").value.trim();
  const langs = getSelectedLanguages();

  if (!name) return alert("Enter project name.");
  if (!langs.length) return alert("Select at least one language.");

  const hasAnyText = blocks.some(b => (b.englishText || "").trim());
  if (!hasAnyText) return alert("Please enter English text in at least one block.");

  const payloadBlocks = blocks
    .map((b, idx) => ({ index: idx, englishText: b.englishText || "", translations: b.translations || {} }))
    .filter(b => b.englishText.trim() || Object.values(b.translations).some(v => (v||"").trim()));

  if (!payloadBlocks.length) return alert("Nothing to save. Please add text or translations.");

  const r = await fetch("/api/saveProject", {
    method: "POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      projectName: name,
      languages: langs,
      status,
      reviewedBy,
      ownerId: currentUser.id,
      blocks: payloadBlocks
    })
  });

  const j = await r.json();
  if (!r.ok) return alert("Save error:\n" + j.error);
  currentProjectId = j.projectId;
  alert("Project saved!");
};

$("#updateProjectBtn").onclick = async () => {
  if (!currentProjectId) return alert("Load a project or save a new one first.");
  if (!currentUser) return alert("Please sign in.");

  syncCurrentBlockFromUI();

  const name = $("#projectName").value.trim();
  const status = $("#projectStatus").value;
  const reviewedBy = $("#reviewedBy").value.trim();
  const langs = getSelectedLanguages();

  if (!name) return alert("Project name cannot be empty.");
  if (!langs.length) return alert("Select at least one language.");

  const hasAnyText = blocks.some(b => (b.englishText || "").trim());
  if (!hasAnyText) return alert("Please enter English text in at least one block.");

  const payloadBlocks = blocks
    .map((b, idx) => ({ index: idx, englishText: b.englishText || "", translations: b.translations || {} }))
    .filter(b => b.englishText.trim() || Object.values(b.translations).some(v => (v||"").trim()));

  if (!payloadBlocks.length) return alert("Nothing to update. Please add text or translations.");

  const r = await fetch("/api/updateProject", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      projectId: currentProjectId,
      projectName: name,
      languages: langs,
      status,
      reviewedBy,
      blocks: payloadBlocks
    })
  });

  const j = await r.json();
  if (!r.ok) return alert("Update error:\n" + j.error);
  alert("Project updated!");
};

/* =====================
   PROJECTS LIST (existing)
===================== */
$("#loadProjectsBtn").onclick = async () => {
  if (!currentUser) return alert("Please sign in to load your projects.");

  const tbl = $("#projectsTable");
  tbl.innerHTML = `
    <tr>
      <th>Project Name</th>
      <th>Status</th>
      <th>Languages</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>`;

  const r = await fetch("/api/getProjects?ownerId=" + encodeURIComponent(currentUser.id));
  const j = await r.json();
  if (!r.ok) return alert("Load error:\n" + j.error);

  const searchTerm = (projectSearch.value || "").toLowerCase();
  const statusVal  = statusFilter.value;

  let projects = j.projects || [];
  if (statusVal) projects = projects.filter(p => p.status === statusVal);
  if (searchTerm) projects = projects.filter(p => (p.project_name||"").toLowerCase().includes(searchTerm));

  for (const p of projects) {
    const langs = (p.languages || []).map(displayLanguage);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.project_name}</td>
      <td>${p.status}</td>
      <td>${langs.join(", ")}</td>
      <td>${new Date(p.created_at).toLocaleString()}</td>
      <td>
        <button class="btn btn-small load-btn" data-id="${p.id}">Load</button>
        <button class="btn btn-small delete-project-btn" data-id="${p.id}">Delete</button>
      </td>`;
    tbl.appendChild(tr);
  }
};

/* =====================
   ADMIN: LOAD ALL PROJECTS
===================== */
$("#adminLoadBtn").onclick = async () => {
  if (!currentUser) return alert("Please sign in.");
  if (!isAdmin) return alert("Admin only.");

  const token = await getAccessToken();
  if (!token) return alert("Missing session token.");

  const tbl = $("#adminProjectsTable");
  tbl.innerHTML = `
    <tr>
      <th>Project</th>
      <th>Owner</th>
      <th>Status</th>
      <th>Languages</th>
      <th>Date</th>
      <th>Admin Actions</th>
    </tr>`;

  const r = await fetch("/api/admin/getAllProjects", {
    headers: { Authorization: "Bearer " + token }
  });
  const j = await r.json();
  if (!r.ok) return alert("Admin load error:\n" + j.error);

  const searchTerm = ($("#adminSearch").value || "").toLowerCase();
  const statusVal  = $("#adminStatusFilter").value;

  let projects = j.projects || [];
  if (statusVal) projects = projects.filter(p => p.status === statusVal);
  if (searchTerm) projects = projects.filter(p => (p.project_name||"").toLowerCase().includes(searchTerm));

  for (const p of projects) {
    const langs = (p.languages || []).map(displayLanguage);
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${p.project_name}</td>
      <td class="muted" style="font-size:12px;">${p.owner_id}</td>
      <td>
        <select class="admin-status" data-id="${p.id}">
          <option value="Draft" ${p.status==="Draft"?"selected":""}>Draft</option>
          <option value="Reviewed" ${p.status==="Reviewed"?"selected":""}>Reviewed</option>
          <option value="Approved" ${p.status==="Approved"?"selected":""}>Approved</option>
        </select>
      </td>
      <td>${langs.join(", ")}</td>
      <td>${new Date(p.created_at).toLocaleString()}</td>
      <td>
        <button class="btn btn-small admin-save-status" data-id="${p.id}">Save status</button>
        <button class="btn btn-small admin-delete" data-id="${p.id}">Delete</button>
      </td>`;
    tbl.appendChild(tr);
  }
};

/* =====================
   BODY CLICK HANDLER
===================== */
document.body.addEventListener("click", async (e) => {
  // + Add block
  if (e.target.matches("#addBlockBtn")) {
    syncCurrentBlockFromUI();
    blocks.push(makeEmptyBlock());
    currentBlockIndex = blocks.length - 1;
    renderBlockTabs();
    renderCurrentBlockToUI();
    return;
  }

  // Delete block
  if (e.target.matches("#deleteBlockBtn")) {
    if (!blocks.length) return;
    if (blocks.length === 1) {
      blocks[0] = makeEmptyBlock();
      currentBlockIndex = 0;
      renderBlockTabs();
      renderCurrentBlockToUI();
      return;
    }
    if (!confirm("Delete this text block?")) return;
    blocks.splice(currentBlockIndex, 1);
    if (currentBlockIndex >= blocks.length) currentBlockIndex = blocks.length - 1;
    if (currentBlockIndex < 0) currentBlockIndex = 0;
    renderBlockTabs();
    renderCurrentBlockToUI();
    return;
  }

  // Click block tab
  if (e.target.matches(".block-tab")) {
    const newIndex = parseInt(e.target.dataset.index, 10);
    if (!Number.isNaN(newIndex) && newIndex !== currentBlockIndex) {
      syncCurrentBlockFromUI();
      currentBlockIndex = newIndex;
      renderBlockTabs();
      renderCurrentBlockToUI();
    }
    return;
  }

  // Delete project (user’s own)
  if (e.target.matches(".delete-project-btn")) {
    const id = e.target.dataset.id;
    if (!id) return;
    if (!confirm("Delete this project? This cannot be undone.")) return;

    const r = await fetch("/api/deleteProject", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ id })
    });
    const j = await r.json();
    if (!r.ok) return alert("Delete error:\n" + j.error);

    alert("Project deleted.");
    const btn = $("#loadProjectsBtn");
    if (btn) btn.click();
    return;
  }

  // Load project
  if (e.target.matches(".load-btn")) {
    const id = e.target.dataset.id;
    const r = await fetch(`/api/getProject?id=${id}`);
    const j = await r.json();
    if (!r.ok) return alert("Error loading project:\n" + j.error);

    const proj = j.project;
    const rows = j.rows || [];

    currentProjectId = proj.id;

    $("#projectName").value = proj.project_name || "";
    $("#projectStatus").value = proj.status || "Draft";

    const firstRow = rows[0] || null;
    $("#reviewedBy").value = firstRow?.reviewed_by || "";

    const infoEl = $("#reviewedInfo");
    infoEl.textContent = firstRow?.reviewed_at
      ? ("Reviewed on: " + new Date(firstRow.reviewed_at).toLocaleString())
      : "";

    const langs = proj.languages || [];
    document.querySelectorAll('#langs input[type=checkbox]').forEach(cb => {
      cb.checked = langs.includes(cb.value);
    });

    if (!rows.length) {
      blocks = [makeEmptyBlock()];
    } else {
      blocks = rows.map(row => ({
        englishText: row.english_text || "",
        translations: {
          "zh-TW": row.zh_tw || "",
          "zh-CN": row.zh_cn || "",
          "ja-JP": row.ja_jp || "",
          "th-TH": row.th_th || "",
          "vi-VN": row.vi_vn || ""
        }
      }));
    }

    currentBlockIndex = 0;
    renderBlockTabs();
    renderCurrentBlockToUI();
    showTranslateTab();
    return;
  }

  // ADMIN: Save status
  if (e.target.matches(".admin-save-status")) {
    if (!isAdmin) return alert("Admin only.");
    const projectId = e.target.dataset.id;
    const sel = document.querySelector(`select.admin-status[data-id="${projectId}"]`);
    const newStatus = sel ? sel.value : null;
    if (!projectId || !newStatus) return;

    const token = await getAccessToken();
    if (!token) return alert("Missing session token.");

    const reviewedBy = $("#reviewedBy").value.trim(); // optional: reuse existing field
    const r = await fetch("/api/admin/setProjectStatus", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ projectId, status: newStatus, reviewedBy })
    });
    const j = await r.json();
    if (!r.ok) return alert("Admin status error:\n" + j.error);

    alert("Status updated.");
    const btn = $("#adminLoadBtn");
    if (btn) btn.click();
    return;
  }

  // ADMIN: Delete
  if (e.target.matches(".admin-delete")) {
    if (!isAdmin) return alert("Admin only.");
    const id = e.target.dataset.id;
    if (!id) return;
    if (!confirm("ADMIN: Delete this project for all users?")) return;

    const token = await getAccessToken();
    if (!token) return alert("Missing session token.");

    const r = await fetch("/api/admin/deleteProject", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ id })
    });
    const j = await r.json();
    if (!r.ok) return alert("Admin delete error:\n" + j.error);

    alert("Project deleted.");
    const btn = $("#adminLoadBtn");
    if (btn) btn.click();
    return;
  }
});
</script>

</body>
</html>
